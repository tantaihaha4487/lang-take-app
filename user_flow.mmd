flowchart TD
    Start([เริ่มต้นแอป]) --> CheckFirstTime{ใช้งานครั้งแรก?}

    %% Onboarding Flow
    CheckFirstTime -- ใช่ --> OnboardingStart[หน้าแนะนำการใช้งาน]
    OnboardingStart --> SelectAppLang[เลือกภาษาของแอป]
    SelectAppLang --> SelectTargetLang[เลือกภาษาที่ต้องการเรียน]
    SelectTargetLang --> SelectMotherLang[เลือกภาษาแม่]
    SelectMotherLang --> CompleteOnboarding[เสร็จสิ้น & บันทึกการตั้งค่า]
    CompleteOnboarding --> MainScreen

    %% Main Screen & Navigation
    CheckFirstTime -- ไม่ --> MainScreen[หน้าหลัก]

    subgraph MainScreenUI [การนำทางหน้าหลัก]
        direction LR
        CameraTab[หน้ากล้อง]
        HistoryTab[หน้าประวัติ]
    end

    MainScreen --> CameraTab

    %% Camera Flow
    subgraph CameraFlow [หน้ากล้อง]
        Preview[แสดงภาพจากกล้องสด]

        %% Top Bar Actions
        Preview -- กดการตั้งค่า --> SettingsDialog[หน้าต่างตั้งค่า]
        SettingsDialog -- รีเซ็ตการแนะนำ --> OnboardingStart
        SettingsDialog -- ปิด --> Preview
        Preview -- เปลี่ยนภาษาที่เรียน --> UpdateLang[อัปเดตภาษาที่เรียน]

        %% Bottom Bar Actions
        Preview -- กดถ่ายภาพ --> Review[ตรวจสอบภาพที่ถ่าย]
        Preview -- กดอัปโหลด --> GalleryPicker[เลือกรูปจากแกลเลอรี]
        Preview -- กดอัลบั้ม --> HistoryTab

        %% Review Logic
        GalleryPicker -- เลือกรูปแล้ว --> Review
        Review -- ถ่ายใหม่ --> Preview
        Review -- ระบุวัตถุ --> Analyzing[กำลังวิเคราะห์ด้วย Gemini AI]

        Analyzing -- สำเร็จ --> Result[การ์ดผลลัพธ์]
        Result -- กดฟังเสียง --> TTS[อ่านออกเสียง - TTS]
        Result -- กดถ่ายภาพใหม่ --> Preview
        Result -- กดปิด --> Review
    end

    %% History Flow
    subgraph HistoryFlow [หน้าประวัติ]
        HistoryList[ตารางประวัติ]
        HistoryList -- กดที่รายการ --> PlayTTS[เล่นเสียง]
        HistoryList -- กดไอคอนกล้อง --> CameraTab
    end

    %% Styles
    classDef start fill:#f9f,stroke:#333,stroke-width:2px;
    classDef process fill:#e1f5fe,stroke:#01579b,stroke-width:2px;
    classDef decision fill:#fff9c4,stroke:#fbc02d,stroke-width:2px;
    classDef screen fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px;

    class Start,OnboardingStart,MainScreen start;
    class CheckFirstTime decision;
    class SelectAppLang,SelectTargetLang,SelectMotherLang,CompleteOnboarding process;
    class CameraTab,HistoryTab screen;
